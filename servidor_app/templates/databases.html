{% extends "base.html" %}

{% block title %}Banco de Dados{% endblock %}

{% block extra_head %}
<style>
.hover-bg-light:hover {
    background-color: #f8f9fa !important;
    transition: background-color 0.2s ease;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #e9ecef;
}

.list-group-item:last-child {
    border-bottom: none;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
}

.badge {
    font-weight: 500;
}

.fs-1 {
    font-size: 3rem !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="bi bi-database me-2"></i>Banco de Dados
                </h1>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Gerenciamento de Banco de Dados</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Funcionalidade em desenvolvimento</strong><br>
                        Esta página será implementada em breve com funcionalidades completas de gerenciamento de banco de dados.
                    </div>

<!-- Estatísticas Gerais -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card border-primary shadow-sm">
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <i class="bi bi-house-door fs-1 text-primary me-3"></i>
                    <div>
                        <h3 class="mb-0">{{ mysql_dbs_local.count if mysql_dbs_local.success else 0 }}</h3>
                        <small class="text-muted">Bancos Locais</small>
                    </div>
                </div>
                <span class="badge bg-primary fs-6">XAMPP</span>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-success shadow-sm">
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <i class="bi bi-cloud fs-1 text-success me-3"></i>
                    <div>
                        <h3 class="mb-0">{{ mysql_dbs_prod.count if mysql_dbs_prod.success else 0 }}</h3>
                        <small class="text-muted">Bancos Produção</small>
                    </div>
                </div>
                <span class="badge bg-success fs-6">AWS RDS</span>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Bancos -->
<div class="row g-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-primary h-100">
            <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0 font-weight-bold">
                    <i class="bi bi-house-door me-2"></i>Bancos de Dados MySQL Locais
                </h5>
                <div class="d-flex align-items-center gap-2">
                    {% if mysql_dbs_local.success %}
                        <span class="badge bg-light text-primary">{{ mysql_dbs_local.count }} bancos</span>
                    {% endif %}
                    <button class="btn btn-success btn-sm" onclick="showImportModal()">
                        <i class="bi bi-plus-circle me-1"></i>
                    </button>
                </div>
            </div>
            <div class="card-body overflow-auto" style="max-height: 400px;">
                {% if mysql_dbs_local.success %}
                    <ul class="list-group list-group-flush">
                        {% for db_name in mysql_dbs_local.databases %}
                            <li class="list-group-item d-flex align-items-center justify-content-between hover-bg-light">
                                <div class="d-flex align-items-center">
                                    {% if db_name == 'db_almoxarifado' %}
                                        <i class="bi bi-archive fs-4 text-warning me-2" title="{{ db_name }}"></i>
                                    {% elif 'crm' in db_name %}
                                        <i class="bi bi-people fs-4 text-info me-2" title="{{ db_name }}"></i>
                                    {% elif 'frota' in db_name %}
                                        <i class="bi bi-truck fs-4 text-secondary me-2" title="{{ db_name }}"></i>
                                    {% elif 'patrimonio' in db_name %}
                                        <i class="bi bi-building fs-4 text-dark me-2" title="{{ db_name }}"></i>
                                    {% else %}
                                        <i class="bi bi-database fs-4 text-primary me-2" title="{{ db_name }}"></i>
                                    {% endif %}
                                    <span class="fs-6 fw-medium">{{ db_name }}</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-info compare-btn"
                                            onclick="compareDatabases('{{ db_name }}')"
                                            title="Comparar banco local {{ db_name }} com produção">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn"
                                            onclick="confirmDeleteDatabase('{{ db_name }}', 'local')"
                                            title="Excluir banco de dados {{ db_name }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Erro ao listar bancos de dados locais:</strong><br>
                        {{ mysql_dbs_local.error }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm border-success h-100">
            <div class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0 font-weight-bold">
                    <i class="bi bi-cloud me-2"></i>Bancos de Dados MySQL Produção
                </h5>
                {% if mysql_dbs_prod.success %}
                    <span class="badge bg-light text-success">{{ mysql_dbs_prod.count }} bancos</span>
                {% endif %}
            </div>
            <div class="card-body overflow-auto" style="max-height: 400px;">
                {% if mysql_dbs_prod.success %}
                    <ul class="list-group list-group-flush">
                        {% for db_name in mysql_dbs_prod.databases %}
                            <li class="list-group-item d-flex align-items-center justify-content-between hover-bg-light">
                                <div class="d-flex align-items-center">
                                    {% if 'almoxarifado' in db_name %}
                                        <i class="bi bi-archive me-3 fs-5 text-warning" title="Almoxarifado"></i>
                                    {% elif 'crm' in db_name %}
                                        <i class="bi bi-people me-3 fs-5 text-info" title="CRM"></i>
                                    {% elif 'frota' in db_name %}
                                        <i class="bi bi-truck me-3 fs-5 text-secondary" title="Frota"></i>
                                    {% elif 'patrimonio' in db_name %}
                                        <i class="bi bi-building me-3 fs-5 text-dark" title="Patrimônio"></i>
                                    {% elif 'gestaotributaria' in db_name %}
                                        <i class="bi bi-calculator me-3 fs-5 text-danger" title="Gestão Tributária"></i>
                                    {% elif 'folha' in db_name %}
                                        <i class="bi bi-cash-stack me-3 fs-5 text-success" title="Folha de Pagamento"></i>
                                    {% elif 'esocial' in db_name %}
                                        <i class="bi bi-file-earmark-text me-3 fs-5 text-primary" title="eSocial"></i>
                                    {% elif 'compras' in db_name %}
                                        <i class="bi bi-cart me-3 fs-5 text-info" title="Compras"></i>
                                    {% elif 'protocolo' in db_name %}
                                        <i class="bi bi-envelope me-3 fs-5 text-secondary" title="Protocolo"></i>
                                    {% elif 'keep_site' in db_name %}
                                        <i class="bi bi-globe me-3 fs-5 text-primary" title="Site"></i>
                                    {% else %}
                                        <i class="bi bi-cloud me-3 fs-5 text-success" title="Produção"></i>
                                    {% endif %}
                                    <span class="fs-6 fw-medium">{{ db_name }}</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success download-btn"
                                            onclick="initiateExportAndDownload('{{ db_name }}')"
                                            title="Baixar banco de dados {{ db_name }}">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary analyze-btn"
                                            onclick="analyzeDatabase('{{ db_name }}')"
                                            title="Analisar banco de dados {{ db_name }}">
                                        <i class="bi bi-bar-chart-line"></i>
                                    </button>
                                    <!-- Removed delete button for production databases as requested -->
                                    <!--
                                    <button class="btn btn-sm btn-outline-danger delete-btn"
                                            onclick="confirmDeleteDatabase('{{ db_name }}', 'producao')"
                                            title="Excluir banco de dados {{ db_name }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    -->
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Erro ao listar bancos de dados de produção:</strong><br>
                        {{ mysql_dbs_prod.error }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Importação de SQL -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="importModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Criar e Importar Banco de Dados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="targetDatabase" class="form-label">
                            <i class="bi bi-database me-1"></i>Nome do Novo Banco de Dados
                        </label>
                        <input type="text" class="form-control" id="targetDatabase" name="targetDatabase" placeholder="Digite o nome do novo banco de dados" required pattern="[a-zA-Z0-9_]+" title="Apenas letras, números e underscore são permitidos">
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Digite o nome do novo banco de dados que será criado e receberá a importação do arquivo SQL.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="sqlFile" class="form-label">
                            <i class="bi bi-file-earmark-code me-1"></i>Arquivo SQL
                        </label>
<input type="file" class="form-control" id="sqlFile" name="sql_file" accept=".sql" required>
                        <div class="form-text">
                            <i class="bi bi-filetype-sql me-1"></i>
                            Selecione um arquivo .sql válido (sem limite de tamanho).
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> Esta operação criará um novo banco de dados e importará os dados do arquivo SQL.
                        Se o banco já existir, ele será sobrescrito. Certifique-se de ter um backup se necessário.
                    </div>
                </form>

                <!-- Barra de progresso (inicialmente oculta) -->
                <div id="importProgressContainer" class="mt-3" style="display: none;">
                    <label class="form-label">Progresso da Importação</label>
                    <div class="progress">
                        <div class="progress-bar" id="importProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <!-- Log de importação (inicialmente oculto) -->
                <div id="importLogContainer" class="mt-3" style="display: none;">
                    <label class="form-label">Log da Importação</label>
                    <div id="importLogContent" class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.875rem; max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                            <br>Iniciando importação...
                        </div>
                    </div>
                </div>

                <!-- Resultados da análise (inicialmente oculto) -->
                <div id="analysisResultsContainer" class="mt-3" style="display: none;">
                    <label class="form-label">Resultados da Análise do Arquivo SQL</label>
                    <div id="analysisResultsContent" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                        <!-- Analysis results will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="startImportBtn" onclick="startImport()">
                    <i class="bi bi-upload me-1"></i>Criar e Importar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Comparação de Banco -->
<div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="compareModalLabel">
                    <i class="bi bi-arrow-left-right me-2"></i>Comparação de Banco de Dados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Progresso da Comparação</label>
                    <div class="progress">
                        <div class="progress-bar" id="compareProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div id="compareLogContent" class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.875rem; max-height: 200px; overflow-y: auto;">
                    <div class="text-center text-muted">
                        <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                        <br>Iniciando comparação do banco de dados...
                    </div>
                </div>
                <div id="compareResults" class="mt-3" style="display: none;">
                    <!-- Results will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Análise de Banco -->
<div class="modal fade" id="analyzeModal" tabindex="-1" aria-labelledby="analyzeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="analyzeModalLabel">
                    <i class="bi bi-bar-chart-line me-2"></i>Análise de Banco de Dados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Progresso da Análise</label>
                    <div class="progress">
                        <div class="progress-bar" id="analyzeProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div id="analyzeLogContent" class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.875rem; max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted">
                        <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                        <br>Iniciando análise do banco de dados...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-trash text-danger fs-1 mb-3"></i>
                    <h5 class="text-danger">Atenção!</h5>
                    <p class="mb-3">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="alert alert-danger">
                    <strong>Você está prestes a excluir o banco de dados:</strong><br>
                    <span id="deleteDbName" class="fw-bold"></span>
                </div>
                <p class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Todos os dados, tabelas e estruturas serão permanentemente removidos.
                </p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmDelete">
                    <label class="form-check-label" for="confirmDelete">
                        Sim, eu entendo que esta ação é irreversível e desejo prosseguir.
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="deleteDatabase()">
                    <i class="bi bi-trash me-1"></i>Excluir Banco
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function downloadDatabase(dbName, button = null, modal = null) {
    // Mostrar loading no botão
    const btn = button || event.target.closest('.download-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    btn.disabled = true;

    // Fazer requisição para download
    fetch(`/databases/download/${dbName}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.blob();
        })
        .then(blob => {
            // Fechar modal assim que receber a resposta do backend
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }

            // Criar link para download
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${dbName}_${new Date().toISOString().split('T')[0]}.sql`;
            document.body.appendChild(a);

            // Iniciar download
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Restaurar botão
            btn.innerHTML = originalText;
            btn.disabled = false;

            // Mostrar sucesso
            showAlert('Banco de dados baixado com sucesso!', 'success');
        })
        .catch(error => {
            console.error('Erro no download:', error);

            // Fechar modal em caso de erro
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }

            // Restaurar botão
            btn.innerHTML = originalText;
            btn.disabled = false;

            // Mostrar erro
            showAlert('Erro ao baixar banco de dados: ' + error.message, 'danger');
        });
}

function initiateExportAndDownload(dbName) {
    // Obter o botão clicado
    const btn = event.target.closest('.download-btn');

    // Criar modal para mostrar o log de exportação com barra de progresso
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'exportModal';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i>Exportação e Download - ${dbName}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exportProgress" class="form-label">Progresso da Exportação</label>
                        <div class="progress">
                            <div class="progress-bar" id="exportProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div id="exportLogContent" class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.875rem; max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                            <br>Iniciando processo de exportação...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    `;

    // Adicionar modal ao body
    document.body.appendChild(modal);

    // Inicializar modal do Bootstrap
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // Remover modal do DOM quando fechado
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });

    // Iniciar exportação automaticamente
    startExportWithProgress(dbName, modal, btn);
}

function startExportWithProgress(dbName, modal, downloadBtn) {
    const logContent = modal.querySelector('#exportLogContent');
    const progressBar = modal.querySelector('#exportProgress');
    const startTime = new Date();

    // Limpar conteúdo anterior
    logContent.innerHTML = '';

    // Adicionar timestamp inicial
    addLogEntry(logContent, `Iniciando exportação do banco ${dbName}...`, 'info');
    addLogEntry(logContent, `Timestamp: ${startTime.toLocaleString()}`, 'info');
    addLogEntry(logContent, '', 'info');

    // Simular processo de exportação com barra de progresso
    simulateExportProcessWithProgress(logContent, progressBar, dbName, startTime, () => {
        // Após exportação completa, iniciar download
        addLogEntry(logContent, 'Iniciando download...', 'info');
        downloadDatabase(dbName, downloadBtn, modal);
    });
}

function simulateExportProcessWithProgress(logContent, progressBar, dbName, startTime, onComplete) {
    const steps = [
        { message: 'Conectando ao servidor MySQL de produção...', delay: 500 },
        { message: 'Verificando permissões do banco de dados...', delay: 300 },
        { message: 'Obtendo lista de tabelas...', delay: 400 },
        { message: 'Exportando estrutura das tabelas...', delay: 800 },
        { message: 'Exportando dados das tabelas...', delay: 2000 },
        { message: 'Criando arquivo SQL de backup...', delay: 600 },
        { message: 'Verificando integridade do backup...', delay: 300 },
        { message: 'Exportação concluída com sucesso!', delay: 200, type: 'success' }
    ];

    let currentStep = 0;

    function executeStep() {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            addLogEntry(logContent, step.message, step.type || 'info');

            // Atualizar barra de progresso
            const progress = ((currentStep + 1) / steps.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            currentStep++;
            setTimeout(executeStep, step.delay);
        } else {
            // Finalizar
            const endTime = new Date();
            const duration = (endTime - startTime) / 1000;
            addLogEntry(logContent, '', 'info');
            addLogEntry(logContent, `Tempo total: ${duration.toFixed(2)} segundos`, 'success');
            addLogEntry(logContent, `Preparando download...`, 'success');

            // Chamar callback para download
            setTimeout(onComplete, 500);
        }
    }

    executeStep();
}

function showExportLog(dbName) {
    // Criar modal para mostrar o log de exportação
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'exportLogModal';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i>Log de Exportação - ${dbName}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="exportLogContent" class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.875rem; max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                            <br>Iniciando processo de exportação...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="startExport('${dbName}')">
                        <i class="bi bi-play me-1"></i>Iniciar Exportação
                    </button>
                </div>
            </div>
        </div>
    `;

    // Adicionar modal ao body
    document.body.appendChild(modal);

    // Inicializar modal do Bootstrap
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // Remover modal do DOM quando fechado
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function startExport(dbName) {
    const logContent = document.getElementById('exportLogContent');
    const startTime = new Date();

    // Limpar conteúdo anterior
    logContent.innerHTML = '';

    // Adicionar timestamp inicial
    addLogEntry(logContent, `Iniciando exportação do banco ${dbName}...`, 'info');
    addLogEntry(logContent, `Timestamp: ${startTime.toLocaleString()}`, 'info');
    addLogEntry(logContent, '', 'info');

    // Simular processo de exportação (você pode substituir por chamada real à API)
    simulateExportProcess(logContent, dbName, startTime);
}

function simulateExportProcess(logContent, dbName, startTime) {
    const steps = [
        { message: 'Conectando ao servidor MySQL local...', delay: 500 },
        { message: 'Verificando permissões do banco de dados...', delay: 300 },
        { message: 'Obtendo lista de tabelas...', delay: 400 },
        { message: 'Exportando estrutura das tabelas...', delay: 800 },
        { message: 'Exportando dados das tabelas...', delay: 2000 },
        { message: 'Criando arquivo SQL de backup...', delay: 600 },
        { message: 'Verificando integridade do backup...', delay: 300 },
        { message: 'Exportação concluída com sucesso!', delay: 200, type: 'success' }
    ];

    let currentStep = 0;

    function executeStep() {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            addLogEntry(logContent, step.message, step.type || 'info');

            currentStep++;
            setTimeout(executeStep, step.delay);
        } else {
            // Finalizar
            const endTime = new Date();
            const duration = (endTime - startTime) / 1000;
            addLogEntry(logContent, '', 'info');
            addLogEntry(logContent, `Tempo total: ${duration.toFixed(2)} segundos`, 'success');
            addLogEntry(logContent, `Arquivo salvo como: ${dbName}_${startTime.toISOString().split('T')[0]}.sql`, 'success');
        }
    }

    executeStep();
}

function addLogEntry(container, message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;

    let icon = '';
    switch(type) {
        case 'success':
            icon = '<i class="bi bi-check-circle text-success me-1"></i>';
            break;
        case 'error':
            icon = '<i class="bi bi-x-circle text-danger me-1"></i>';
            break;
        case 'warning':
            icon = '<i class="bi bi-exclamation-triangle text-warning me-1"></i>';
            break;
        default:
            icon = '<i class="bi bi-info-circle text-info me-1"></i>';
    }

    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${icon}${message}`;
    container.appendChild(logEntry);
    container.scrollTop = container.scrollHeight;
}

function showAlert(message, type) {
    // Criar alerta
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Adicionar ao body
    document.body.appendChild(alertDiv);

    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function analyzeDatabase(dbName) {
    // Criar modal para mostrar o progresso da análise
    const modal = document.getElementById('analyzeModal');
    const bsModal = new bootstrap.Modal(modal, {
        backdrop: 'static',
        keyboard: false
    });
    bsModal.show();

    // Iniciar análise com progresso
    startAnalysisWithProgress(dbName, modal);
}

function startAnalysisWithProgress(dbName, modal) {
    const logContent = modal.querySelector('#analyzeLogContent');
    const progressBar = modal.querySelector('#analyzeProgress');
    const startTime = new Date();

    // Limpar conteúdo anterior
    logContent.innerHTML = '';

    // Adicionar timestamp inicial
    addLogEntry(logContent, `Iniciando análise do banco ${dbName}...`, 'info');
    addLogEntry(logContent, `Timestamp: ${startTime.toLocaleString()}`, 'info');
    addLogEntry(logContent, '', 'info');

    // Simular processo de análise com barra de progresso
    simulateAnalysisProcessWithProgress(logContent, progressBar, dbName, startTime, () => {
        // Após análise completa, fechar modal e redirecionar
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();
        window.location.href = `/databases/analyze/${dbName}`;
    });
}

function simulateAnalysisProcessWithProgress(logContent, progressBar, dbName, startTime, onComplete) {
    const steps = [
        { message: 'Conectando ao banco de dados...', delay: 500 },
        { message: 'Verificando permissões e estrutura...', delay: 300 },
        { message: 'Coletando metadados das tabelas...', delay: 800 },
        { message: 'Analisando colunas e relacionamentos...', delay: 1000 },
        { message: 'Gerando diagrama ERD...', delay: 1500 },
        { message: 'Gerando diagrama de fluxo de dados...', delay: 1200 },
        { message: 'Criando documentação em Markdown...', delay: 600 },
        { message: 'Salvando diagramas e arquivos...', delay: 400 },
        { message: 'Análise concluída com sucesso!', delay: 200, type: 'success' }
    ];

    let currentStep = 0;

    function executeStep() {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            addLogEntry(logContent, step.message, step.type || 'info');

            // Atualizar barra de progresso
            const progress = ((currentStep + 1) / steps.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            currentStep++;
            setTimeout(executeStep, step.delay);
        } else {
            // Finalizar
            const endTime = new Date();
            const duration = (endTime - startTime) / 1000;
            addLogEntry(logContent, '', 'info');
            addLogEntry(logContent, `Tempo total: ${duration.toFixed(2)} segundos`, 'success');
            addLogEntry(logContent, `Redirecionando para página de análise...`, 'success');

            // Chamar callback para redirecionamento
            setTimeout(onComplete, 500);
        }
    }

    executeStep();
}

function compareDatabases(dbName) {
    // Criar modal para mostrar o progresso da comparação
    const modal = document.getElementById('compareModal');
    const bsModal = new bootstrap.Modal(modal, {
        backdrop: 'static',
        keyboard: false
    });
    bsModal.show();

    // Iniciar comparação com progresso
    startComparisonWithProgress(dbName, modal);
}

function startComparisonWithProgress(dbName, modal) {
    const logContent = modal.querySelector('#compareLogContent');
    const progressBar = modal.querySelector('#compareProgress');
    const resultsContainer = modal.querySelector('#compareResults');
    const startTime = new Date();

    // Limpar conteúdo anterior
    logContent.innerHTML = '';
    resultsContainer.style.display = 'none';
    resultsContainer.innerHTML = '';

    // Adicionar timestamp inicial
    addLogEntry(logContent, `Iniciando comparação do banco ${dbName}...`, 'info');
    addLogEntry(logContent, `Timestamp: ${startTime.toLocaleString()}`, 'info');
    addLogEntry(logContent, '', 'info');

    // Simular processo de comparação com barra de progresso
    simulateComparisonProcessWithProgress(logContent, progressBar, dbName, startTime, () => {
        // Após comparação completa, fazer requisição AJAX para obter resultados
        addLogEntry(logContent, 'Obtendo resultados da comparação...', 'info');

        fetch(`/databases/compare/${dbName}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    displayComparisonResults(resultsContainer, data.comparison, dbName);
                    resultsContainer.style.display = 'block';
                    addLogEntry(logContent, 'Comparação concluída com sucesso!', 'success');
                } else {
                    addLogEntry(logContent, `Erro: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Erro na comparação:', error);
                addLogEntry(logContent, `Erro na comparação: ${error.message}`, 'error');
            });
    });
}

function simulateComparisonProcessWithProgress(logContent, progressBar, dbName, startTime, onComplete) {
    const steps = [
        { message: 'Conectando aos bancos de dados local e produção...', delay: 500 },
        { message: 'Verificando permissões e estrutura...', delay: 300 },
        { message: 'Obtendo lista de tabelas...', delay: 600 },
        { message: 'Comparando estruturas das tabelas...', delay: 1000 },
        { message: 'Analisando diferenças de colunas...', delay: 1200 },
        { message: 'Comparando dados das tabelas...', delay: 1500 },
        { message: 'Gerando relatório de diferenças...', delay: 800 },
        { message: 'Comparação concluída com sucesso!', delay: 200, type: 'success' }
    ];

    let currentStep = 0;

    function executeStep() {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            addLogEntry(logContent, step.message, step.type || 'info');

            // Atualizar barra de progresso
            const progress = ((currentStep + 1) / steps.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            currentStep++;
            setTimeout(executeStep, step.delay);
        } else {
            // Finalizar
            const endTime = new Date();
            const duration = (endTime - startTime) / 1000;
            addLogEntry(logContent, '', 'info');
            addLogEntry(logContent, `Tempo total: ${duration.toFixed(2)} segundos`, 'success');

            // Chamar callback para obter resultados
            setTimeout(onComplete, 500);
        }
    }

    executeStep();
}

function displayComparisonResults(container, comparison, dbName) {
    container.innerHTML = `
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    Resultados da Comparação: ${dbName}
                </h5>
            </div>
            <div class="card-body">
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="bi bi-table me-2"></i>
                                    Tabelas Comuns
                                </h5>
                                <h2>${comparison.tables.common.length}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Apenas Local
                                </h5>
                                <h2>${comparison.tables.missing_in_prod.length}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="bi bi-dash-circle me-2"></i>
                                    Apenas Produção
                                </h5>
                                <h2>${comparison.tables.missing_in_local.length}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Diferenças
                                </h5>
                                <h2>${Object.keys(comparison.columns).length + Object.keys(comparison.data).length}</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tables Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-table me-2"></i>
                                    Comparação de Tabelas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Missing in Production -->
                                    <div class="col-md-6">
                                        <h6 class="text-success">
                                            <i class="bi bi-plus-circle me-2"></i>
                                            Tabelas presentes apenas no Local (${comparison.tables.missing_in_prod.length})
                                        </h6>
                                        ${comparison.tables.missing_in_prod.length > 0 ?
                                            `<div class="table-responsive">
                                                <table class="table table-sm table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Nome da Tabela</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${comparison.tables.missing_in_prod.map(table =>
                                                            `<tr>
                                                                <td>
                                                                    <span class="badge bg-success">
                                                                        <i class="bi bi-plus-circle me-1"></i>
                                                                        ${table}
                                                                    </span>
                                                                </td>
                                                            </tr>`
                                                        ).join('')}
                                                    </tbody>
                                                </table>
                                            </div>` :
                                            '<p class="text-muted">Nenhuma tabela exclusiva do ambiente local.</p>'
                                        }
                                    </div>

                                    <!-- Missing in Local -->
                                    <div class="col-md-6">
                                        <h6 class="text-warning">
                                            <i class="bi bi-dash-circle me-2"></i>
                                            Tabelas presentes apenas na Produção (${comparison.tables.missing_in_local.length})
                                        </h6>
                                        ${comparison.tables.missing_in_local.length > 0 ?
                                            `<div class="table-responsive">
                                                <table class="table table-sm table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Nome da Tabela</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${comparison.tables.missing_in_local.map(table =>
                                                            `<tr>
                                                                <td>
                                                                    <span class="badge bg-warning">
                                                                        <i class="bi bi-dash-circle me-1"></i>
                                                                        ${table}
                                                                    </span>
                                                                </td>
                                                            </tr>`
                                                        ).join('')}
                                                    </tbody>
                                                </table>
                                            </div>` :
                                            '<p class="text-muted">Nenhuma tabela exclusiva do ambiente de produção.</p>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column Differences -->
                ${Object.keys(comparison.columns).length > 0 ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-columns me-2"></i>
                                    Diferenças de Colunas (${Object.keys(comparison.columns).length} tabelas)
                                </h5>
                            </div>
                            <div class="card-body">
                                ${Object.entries(comparison.columns).map(([table, diffs]) => `
                                    <div class="mb-4">
                                        <h6 class="text-info">
                                            <i class="bi bi-table me-2"></i>
                                            Tabela: ${table}
                                        </h6>
                                        <div class="row">
                                            <!-- Missing columns in production -->
                                            ${diffs.missing_in_prod && diffs.missing_in_prod.length > 0 ? `
                                            <div class="col-md-4">
                                                <h7 class="text-success">Colunas apenas no Local</h7>
                                                <ul class="list-group list-group-flush">
                                                    ${diffs.missing_in_prod.map(col =>
                                                        `<li class="list-group-item py-1">
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-plus-circle me-1"></i>
                                                                ${col}
                                                            </span>
                                                        </li>`
                                                    ).join('')}
                                                </ul>
                                            </div>` : ''}
                                            <!-- Missing columns in local -->
                                            ${diffs.missing_in_local && diffs.missing_in_local.length > 0 ? `
                                            <div class="col-md-4">
                                                <h7 class="text-warning">Colunas apenas na Produção</h7>
                                                <ul class="list-group list-group-flush">
                                                    ${diffs.missing_in_local.map(col =>
                                                        `<li class="list-group-item py-1">
                                                            <span class="badge bg-warning">
                                                                <i class="bi bi-dash-circle me-1"></i>
                                                                ${col}
                                                            </span>
                                                        </li>`
                                                    ).join('')}
                                                </ul>
                                            </div>` : ''}
                                            <!-- Type differences -->
                                            ${diffs.type_differences && Object.keys(diffs.type_differences).length > 0 ? `
                                            <div class="col-md-4">
                                                <h7 class="text-danger">Diferenças de Tipo</h7>
                                                <ul class="list-group list-group-flush">
                                                    ${Object.entries(diffs.type_differences).map(([col, types]) =>
                                                        `<li class="list-group-item py-1">
                                                            <strong>${col}:</strong><br>
                                                            <small>
                                                                <span class="text-success">Local: ${types.local}</span><br>
                                                                <span class="text-warning">Prod: ${types.prod}</span>
                                                            </small>
                                                        </li>`
                                                    ).join('')}
                                                </ul>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>` : ''}

                <!-- Data Differences -->
                ${Object.keys(comparison.data).length > 0 ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-bar-chart-line me-2"></i>
                                    Diferenças de Dados (${Object.keys(comparison.data).length} tabelas)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Tabela</th>
                                                <th>Registros Local</th>
                                                <th>Registros Produção</th>
                                                <th>Diferença</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(comparison.data).map(([table, data]) => `
                                                <tr>
                                                    <td>
                                                        <strong>${table}</strong>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary">${data.local_count}</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-secondary">${data.prod_count}</span>
                                                    </td>
                                                    <td class="text-center">
                                                        ${data.difference > 0 ?
                                                            `<span class="badge bg-success">+${data.difference}</span>` :
                                                            data.difference < 0 ?
                                                            `<span class="badge bg-warning">${data.difference}</span>` :
                                                            `<span class="badge bg-info">0</span>`
                                                        }
                                                    </td>
                                                    <td>
                                                        ${data.difference > 0 ?
                                                            '<span class="text-success"><i class="bi bi-arrow-up-circle me-1"></i>Local tem mais registros</span>' :
                                                            data.difference < 0 ?
                                                            '<span class="text-warning"><i class="bi bi-arrow-down-circle me-1"></i>Produção tem mais registros</span>' :
                                                            '<span class="text-info"><i class="bi bi-check-circle me-1"></i>Contagens iguais</span>'
                                                        }
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>` : ''}

                <!-- Summary -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-clipboard-check me-2"></i>
                                    Resumo da Comparação
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <h4 class="text-primary">${comparison.tables.common.length}</h4>
                                        <p class="mb-0">Tabelas em comum</p>
                                    </div>
                                    <div class="col-md-3">
                                        <h4 class="text-success">${comparison.tables.missing_in_prod.length}</h4>
                                        <p class="mb-0">Tabelas apenas no local</p>
                                    </div>
                                    <div class="col-md-3">
                                        <h4 class="text-warning">${comparison.tables.missing_in_local.length}</h4>
                                        <p class="mb-0">Tabelas apenas na produção</p>
                                    </div>
                                    <div class="col-md-3">
                                        <h4 class="text-info">${Object.keys(comparison.columns).length + Object.keys(comparison.data).length}</h4>
                                        <p class="mb-0">Diferenças encontradas</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Variáveis globais para controle da exclusão
let currentDbToDelete = null;
let currentDbType = null;

function confirmDeleteDatabase(dbName, dbType) {
    // Definir variáveis globais
    currentDbToDelete = dbName;
    currentDbType = dbType;

    // Atualizar o nome do banco no modal
    document.getElementById('deleteDbName').textContent = dbName;

    // Resetar checkbox
    document.getElementById('confirmDelete').checked = false;

    // Desabilitar botão de exclusão
    document.getElementById('confirmDeleteBtn').disabled = true;

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function deleteDatabase() {
    if (!currentDbToDelete || !currentDbType) {
        showAlert('Erro: Banco de dados não especificado.', 'danger');
        return;
    }

    // Verificar se o checkbox está marcado
    if (!document.getElementById('confirmDelete').checked) {
        showAlert('Por favor, confirme que você entende que esta ação é irreversível.', 'warning');
        return;
    }

    // Obter referências aos elementos do modal
    const modal = document.getElementById('deleteModal');
    const bsModal = bootstrap.Modal.getInstance(modal);
    const deleteBtn = document.getElementById('confirmDeleteBtn');

    // Desabilitar botão e mostrar loading
    deleteBtn.disabled = true;
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Excluindo...';

    // Manter modal aberto durante a exclusão
    // Não fechar modal ainda

    // Fazer requisição para exclusão
    fetch(`/databases/delete/${currentDbToDelete}?type=${currentDbType}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Fechar modal e mostrar sucesso
            bsModal.hide();
            showAlert(`Banco de dados "${currentDbToDelete}" excluído com sucesso!`, 'success');

            // Recarregar a página após 2 segundos
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            // Reabilitar botão e mostrar erro
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalText;
            showAlert(`Erro ao excluir banco de dados: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Erro na exclusão:', error);

        // Reabilitar botão e mostrar erro
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        showAlert(`Erro ao excluir banco de dados: ${error.message}`, 'danger');
    });
}

// Função para mostrar o modal de importação
function showImportModal() {
    // Resetar formulário
    const form = document.getElementById('importForm');
    form.reset();

    // Esconder elementos de progresso e log
    document.getElementById('importProgressContainer').style.display = 'none';
    document.getElementById('importLogContainer').style.display = 'none';

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

// Função para iniciar a importação
function startImport() {
    const form = document.getElementById('importForm');
    const formData = new FormData(form);

    // Validar formulário
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Obter valores do formulário
    const targetDatabase = document.getElementById('targetDatabase').value;
    const sqlFile = document.getElementById('sqlFile').files[0];

    // Obter elementos do modal
    const modal = document.getElementById('importModal');
    const progressContainer = document.getElementById('importProgressContainer');
    const progressBar = document.getElementById('importProgress');
    const logContainer = document.getElementById('importLogContainer');
    const logContent = document.getElementById('importLogContent');
    const startBtn = document.getElementById('startImportBtn');

    // Desabilitar botão e mostrar loading
    startBtn.disabled = true;
    const originalText = startBtn.innerHTML;
    startBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Importando...';

    // Mostrar barra de progresso e log
    progressContainer.style.display = 'block';
    logContainer.style.display = 'block';

    // Limpar log anterior
    logContent.innerHTML = '';

    // Adicionar timestamp inicial
    const startTime = new Date();
    addLogEntry(logContent, `Iniciando importação do banco "${targetDatabase}"...`, 'info');
    addLogEntry(logContent, `Arquivo: ${sqlFile.name}`, 'info');
    addLogEntry(logContent, `Tamanho: ${(sqlFile.size / 1024 / 1024).toFixed(2)} MB`, 'info');
    addLogEntry(logContent, `Timestamp: ${startTime.toLocaleString()}`, 'info');
    addLogEntry(logContent, '', 'info');

    // Criar FormData para envio
    const uploadData = new FormData();
    uploadData.append('sql_file', sqlFile);

    // Fazer requisição para o backend
    fetch(`/databases/import/${targetDatabase}`, {
        method: 'POST',
        body: uploadData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Importação bem-sucedida
            addLogEntry(logContent, 'Importação concluída com sucesso!', 'success');
            addLogEntry(logContent, data.message || 'Banco de dados criado e populado.', 'success');

            // Atualizar barra de progresso para 100%
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', 100);

            // Calcular tempo total
            const endTime = new Date();
            const duration = (endTime - startTime) / 1000;
            addLogEntry(logContent, '', 'info');
            addLogEntry(logContent, `Tempo total: ${duration.toFixed(2)} segundos`, 'success');

            // Exibir resultados da análise se disponíveis
            if (data.analysis_results) {
                displayAnalysisResults(data.analysis_results, targetDatabase);
            }

            // Reabilitar botão
            startBtn.disabled = false;
            startBtn.innerHTML = originalText;

            // Fechar modal após alguns segundos
            setTimeout(() => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
                showAlert('Importação concluída com sucesso!', 'success');

                // Recarregar página para atualizar lista de bancos
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }, 3000);

        } else {
            // Erro na importação
            addLogEntry(logContent, 'Erro na importação!', 'error');
            addLogEntry(logContent, data.error || 'Erro desconhecido', 'error');

            if (data.details) {
                addLogEntry(logContent, `Detalhes: ${data.details}`, 'error');
            }

            if (data.suggestion) {
                addLogEntry(logContent, `Sugestão: ${data.suggestion}`, 'warning');
            }

            // Reabilitar botão
            startBtn.disabled = false;
            startBtn.innerHTML = originalText;

            // Mostrar erro
            showAlert(`Erro na importação: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Erro na importação:', error);

        // Adicionar erro ao log
        addLogEntry(logContent, 'Erro na comunicação com o servidor!', 'error');
        addLogEntry(logContent, error.message, 'error');

        // Reabilitar botão
        startBtn.disabled = false;
        startBtn.innerHTML = originalText;

        // Mostrar erro
        showAlert(`Erro na importação: ${error.message}`, 'danger');
    });

    // Simular progresso visual enquanto a requisição está em andamento
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) { // Não chega a 100% até receber resposta
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
        }
    }, 500);

    // Limpar intervalo quando a requisição terminar (será feito no then/catch)
    // Nota: Em um cenário real, você poderia usar Server-Sent Events ou WebSockets
    // para receber atualizações de progresso em tempo real do backend
}



// Função para exibir resultados da análise
function displayAnalysisResults(analysisResults, databaseName) {
    const container = document.getElementById('analysisResultsContainer');
    const content = document.getElementById('analysisResultsContent');

    if (!container || !content) {
        console.error('Container de resultados da análise não encontrado');
        return;
    }

    // Limpar conteúdo anterior
    content.innerHTML = '';

    // Criar conteúdo da análise
    let html = `
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Análise do Arquivo SQL - ${databaseName}
                </h5>
            </div>
            <div class="card-body">
    `;

    // Estatísticas gerais
    if (analysisResults.stats) {
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="bi bi-table me-2"></i>
                                Tabelas
                            </h5>
                            <h2>${analysisResults.stats.tables || 0}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="bi bi-columns me-2"></i>
                                Colunas
                            </h5>
                            <h2>${analysisResults.stats.columns || 0}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="bi bi-key me-2"></i>
                                Chaves
                            </h5>
                            <h2>${analysisResults.stats.constraints || 0}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="bi bi-file-earmark-code me-2"></i>
                                Statements
                            </h5>
                            <h2>${analysisResults.stats.statements || 0}</h2>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Lista de tabelas
    if (analysisResults.tables && analysisResults.tables.length > 0) {
        html += `
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-table me-2"></i>
                                Tabelas Encontradas (${analysisResults.tables.length})
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Nome da Tabela</th>
                                            <th>Colunas</th>
                                            <th>Tipo</th>
                                            <th>Engine</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;

        analysisResults.tables.forEach(table => {
            html += `
                <tr>
                    <td>
                        <strong>${table.name}</strong>
                    </td>
                    <td>
                        <span class="badge bg-primary">${table.columns || 0}</span>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${table.type || 'TABLE'}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">${table.engine || 'InnoDB'}</span>
                    </td>
                </tr>
            `;
        });

        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Avisos e problemas
    if (analysisResults.warnings && analysisResults.warnings.length > 0) {
        html += `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Avisos (${analysisResults.warnings.length})
                            </h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
        `;

        analysisResults.warnings.forEach(warning => {
            html += `
                <li class="list-group-item">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle text-warning me-2 mt-1"></i>
                        <div>
                            <strong>${warning.type}:</strong> ${warning.message}
                            ${warning.line ? `<br><small class="text-muted">Linha: ${warning.line}</small>` : ''}
                        </div>
                    </div>
                </li>
            `;
        });

        html += `
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Erros
    if (analysisResults.errors && analysisResults.errors.length > 0) {
        html += `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-x-circle me-2"></i>
                                Erros (${analysisResults.errors.length})
                            </h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
        `;

        analysisResults.errors.forEach(error => {
            html += `
                <li class="list-group-item">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-x-circle text-danger me-2 mt-1"></i>
                        <div>
                            <strong>${error.type}:</strong> ${error.message}
                            ${error.line ? `<br><small class="text-muted">Linha: ${error.line}</small>` : ''}
                        </div>
                    </div>
                </li>
            `;
        });

        html += `
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Informações adicionais
    if (analysisResults.metadata) {
        html += `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-info-circle me-2"></i>
                                Informações do Arquivo
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Tamanho:</strong> ${(analysisResults.metadata.size / 1024 / 1024).toFixed(2)} MB</p>
                                    <p><strong>Codificação:</strong> ${analysisResults.metadata.encoding || 'UTF-8'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Data de Análise:</strong> ${new Date().toLocaleString()}</p>
                                    <p><strong>Versão MySQL:</strong> ${analysisResults.metadata.mysql_version || 'Não detectada'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    html += `
            </div>
        </div>
    `;

    // Inserir conteúdo
    content.innerHTML = html;

    // Mostrar container
    container.style.display = 'block';

    // Scroll para o container
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Event listener para o checkbox de confirmação
document.addEventListener('DOMContentLoaded', function() {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteBtn = document.getElementById('confirmDeleteBtn');

    if (confirmCheckbox && deleteBtn) {
        confirmCheckbox.addEventListener('change', function() {
            deleteBtn.disabled = !this.checked;
        });
    }
});
</script>

{% endblock %}
